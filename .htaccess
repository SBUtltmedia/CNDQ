# Production - use Shibboleth authentication
# Note: Local development uses .env file instead (Herd uses Nginx, not Apache)
<IfModule mod_shib>
    AuthType shibboleth
    ShibRequestSetting requireSession true
    require shibboleth
</IfModule>
SetEnv PHP_VALUE "session.save_path=/home/tltsecure/apache2/htdocs/userData/sessionData"

# URL Rewriting: Make .php extension optional
<IfModule mod_rewrite.c>
    RewriteEngine On

    # WebSocket Proxy: Forward /ws to amphp server on port 8080
    # Requires mod_proxy and mod_proxy_wstunnel to be enabled
    # Pass the authenticated user email from Shibboleth to the internal server
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^ws/?(.*) ws://127.0.0.1:8080/$1 [P,L,E=REMOTE_USER:%{LA-U:REMOTE_USER}]
    
    # Optional: Pass user info via Header if amphp needs it specifically
    RequestHeader set X-Remote-User %{REMOTE_USER}e env=REMOTE_USER

    # If the request is for a file or directory that exists, serve it directly
    RewriteCond %{REQUEST_FILENAME} -f [OR]
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule ^ - [L]

    # If the request doesn't have .php extension and the .php file exists, rewrite to it
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME}\.php -f
    RewriteRule ^(.*)$ $1.php [L,QSA]

    # If the request is for a directory, try index.php
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule ^(.*)$ $1/index.php [L,QSA]
</IfModule>
